<#
.SYNOPSIS
    Installs the application: ${appName}
    Version: ${version}
    Publisher: ${publisher}
.DESCRIPTION
    This script is automatically generated by the Intune Package Utility.
#>
$ErrorActionPreference = "Stop"

# Logging Infrastructure
$LogDir = "C:\Program Files\_MEM\Log"
if (!(Test-Path $LogDir)) { New-Item -Path $LogDir -ItemType Directory -Force | Out-Null }
$LogFile = Join-Path $LogDir "${appName}_install.log"

function Log-Message {
    param([string]$Message)
    $TimeStamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $FormattedMessage = "[$TimeStamp] $Message"
    Write-Host $FormattedMessage
    $FormattedMessage | Out-File -FilePath $LogFile -Append -Encoding utf8
}

try {
    Log-Message "Starting installation for ${appName}"
    Log-Message "Version: ${version}"
    Log-Message "Publisher: ${publisher}"
    
    # Pre-install custom script entries
#if( $preInstallScript && $preInstallScript != "" )
    Log-Message "Executing pre-install script entries..."
    $preInstallScript
#end
    
    $ExitCode = 1
    $MaxRetries = 3
    $RetryCount = 0
    $WaitSeconds = 10

    while ($RetryCount -lt $MaxRetries) {
        $RetryCount++
        Log-Message "Attempt $RetryCount of $MaxRetries..."

        if ("${sourceType}" -eq "MSI") {
            $MSILog = Join-Path $LogDir "${appName}_msi.log"
            Log-Message "Executing MSI install: msiexec /i `"${sourceFileName}`" /qn /L*v `"$MSILog`""
            $proc = Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"${sourceFileName}`" /qn /L*v `"$MSILog`"" -Wait -PassThru
        } else {
            Log-Message "Executing EXE install: .\${sourceFileName} ${installCmdArgs}"
            $proc = Start-Process -FilePath ".\${sourceFileName}" -ArgumentList '${installCmdArgs}' -Wait -PassThru
        }

        $ExitCode = $proc.ExitCode
        Log-Message "Process exited with code: $ExitCode"

        # Success codes: 0, 3010 (Reboot Required)
        if ($ExitCode -eq 0 -or $ExitCode -eq 3010) {
            Log-Message "Installation successful (Exit Code: $ExitCode)."
            exit 0
        }

        if ($RetryCount -lt $MaxRetries) {
            Log-Message "Installation failed. Retrying in $WaitSeconds seconds..."
            Start-Sleep -Seconds $WaitSeconds
        }
    }

    throw "Installation failed after $MaxRetries attempts with exit code $ExitCode"

} catch {
    Log-Message "CRITICAL ERROR: $($_.Exception.Message)"
    exit 1
}
