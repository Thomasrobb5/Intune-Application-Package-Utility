<#
.SYNOPSIS
    Detects the application: ${appName}
    Version: ${version}
    Publisher: ${publisher}
.DESCRIPTION
    This script is automatically generated by the Intune Package Utility.
#>
$ErrorActionPreference = "Stop"

# Logging Infrastructure (Minimal for Detection)
$LogDir = "C:\Program Files\_MEM\Log"
if (!(Test-Path $LogDir)) { New-Item -Path $LogDir -ItemType Directory -Force | Out-Null }
$LogFile = Join-Path $LogDir "${appName}_detection.log"

function Log-Message {
    param([string]$Message)
    $TimeStamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $FormattedMessage = "[$TimeStamp] $Message"
    Write-Host $FormattedMessage
    $FormattedMessage | Out-File -FilePath $LogFile -Append -Encoding utf8
}

try {
    # If it is MSI, we can detect via the product code in the registry.
    if ("${sourceType}" -eq "MSI") {
        $productCode = "${detectionRule}"
        $uninstallKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$productCode"
        $wow64UninstallKey = "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\$productCode"
        
        if ((Test-Path $uninstallKey) -or (Test-Path $wow64UninstallKey)) {
            Log-Message "Detected MSI product code $productCode"
            $host.SetShouldExit(0)
            exit 0
        }
    } else {
        # For EXE, detection might require checking the installed path or a specific registry key
        # Default fallback mechanism using the custom detection rule field
        $rule = "${detectionRule}"
        
        if ($rule -like "HK*") {
            # Basic registry detection
            if (Test-Path $rule) {
                Log-Message "Detected registry key $rule"
                $host.SetShouldExit(0)
                exit 0
            }
        } elseif ($rule -like "?:\*") {
            # Basic file path detection
            if (Test-Path $rule) {
                Log-Message "Detected file path $rule"
                $host.SetShouldExit(0)
                exit 0
            }
        }
    }

    # If we fall through, the application is not detected.
    Log-Message "Application not detected."
    # Exit 0 with no stdout tells Intune the app is NOT installed yet.
    $host.SetShouldExit(0)
    exit 0
} catch {
    Log-Message "DETECTION ERROR: $($_.Exception.Message)"
    # Exit 1 tells Intune there was an error in detection.
    $host.SetShouldExit(1)
    exit 1
}
