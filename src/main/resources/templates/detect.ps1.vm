<#
.SYNOPSIS
    Detects the application: ${appName}
    Version: ${version}
    Publisher: ${publisher}
.DESCRIPTION
    This script is automatically generated by the Intune Package Utility.
#>
$ErrorActionPreference = "Stop"

try {
    # If it is MSI, we can detect via the product code in the registry.
    if ("${sourceType}" -eq "MSI") {
        $productCode = "${detectionRule}"
        $uninstallKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$productCode"
        $wow64UninstallKey = "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\$productCode"
        
        if ((Test-Path $uninstallKey) -or (Test-Path $wow64UninstallKey)) {
            Write-Host "Detected MSI product code $productCode"
            $host.SetShouldExit(0)
            exit 0
        }
    } else {
        # For EXE, detection might require checking the installed path or a specific registry key
        # Default fallback mechanism using the custom detection rule field
        # The user could input a registry path or a file path
        $rule = "${detectionRule}"
        
        if ($rule -like "HK*") {
            # Basic registry detection
            if (Test-Path $rule) {
                Write-Host "Detected registry key $rule"
                $host.SetShouldExit(0)
                exit 0
            }
        } elseif ($rule -like "?:\*") {
            # Basic file path detection
            if (Test-Path $rule) {
                Write-Host "Detected file path $rule"
                $host.SetShouldExit(0)
                exit 0
            }
        }
    }

    # If we fall through, the application is not detected.
    Write-Host "Application not detected."
    # Exit 0 with no stdout tells Intune the app is NOT installed yet.
    $host.SetShouldExit(0)
    exit 0
} catch {
    Write-Error $_.Exception.Message
    # Exit 1 tells Intune there was an error in detection.
    $host.SetShouldExit(1)
    exit 1
}
